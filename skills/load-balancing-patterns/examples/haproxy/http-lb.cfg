# HAProxy HTTP Load Balancer Configuration
# Version: 2.8+
# This configuration demonstrates production-ready HTTP/HTTPS load balancing with health checks

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # Logging configuration
    log /dev/log local0
    log /dev/log local1 notice

    # Process management
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL/TLS settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Performance tuning
    tune.ssl.default-dh-param 2048
    maxconn 4096

#---------------------------------------------------------------------
# Default settings for all proxies
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch

    # Timeouts
    timeout connect 5s
    timeout client  50s
    timeout server  50s

    # Error handling
    retries 3
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# Statistics page (password: changeme)
#---------------------------------------------------------------------
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:changeme
    stats admin if TRUE

#---------------------------------------------------------------------
# Frontend: HTTP traffic (port 80)
#---------------------------------------------------------------------
frontend http_front
    bind *:80

    # ACL rules for request routing
    # Match requests with /api prefix
    acl is_api path_beg /api
    # Match requests for specific host
    acl is_admin_host hdr(host) -i admin.example.com
    # Match requests based on source IP
    acl is_internal_ip src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16

    # Routing decisions based on ACLs
    use_backend api_backend if is_api
    use_backend admin_backend if is_admin_host
    use_backend internal_backend if is_internal_ip

    # Default backend
    default_backend web_backend

    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"

#---------------------------------------------------------------------
# Frontend: HTTPS traffic (port 443)
#---------------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/example.com.pem alpn h2,http/1.1

    # Redirect HTTP to HTTPS
    http-request redirect scheme https unless { ssl_fc }

    # ACL rules (same as HTTP frontend)
    acl is_api path_beg /api
    acl is_admin_host hdr(host) -i admin.example.com
    acl is_internal_ip src 10.0.0.0/8

    # Routing
    use_backend api_backend if is_api
    use_backend admin_backend if is_admin_host
    use_backend internal_backend if is_internal_ip
    default_backend web_backend

    # HSTS header (6 months)
    http-response set-header Strict-Transport-Security "max-age=15768000; includeSubDomains"

#---------------------------------------------------------------------
# Backend: Web servers (round-robin with session persistence)
#---------------------------------------------------------------------
backend web_backend
    # Load balancing algorithm: round-robin
    # Alternatives: leastconn, source, uri, random
    balance roundrobin

    # Session persistence using cookies
    cookie SERVERID insert indirect nocache httponly secure

    # Health check: HTTP GET to /health
    option httpchk GET /health HTTP/1.1\r\nHost:\ www.example.com
    http-check expect status 200

    # Server definitions
    # server <name> <address>:<port> [options]
    server web1 10.0.1.10:8080 check cookie web1 weight 100 maxconn 500
    server web2 10.0.1.11:8080 check cookie web2 weight 100 maxconn 500
    server web3 10.0.1.12:8080 check cookie web3 weight 100 maxconn 500
    # Backup server (only used when all others are down)
    server web4 10.0.1.13:8080 check backup

#---------------------------------------------------------------------
# Backend: API servers (least connections)
#---------------------------------------------------------------------
backend api_backend
    # Use least connections algorithm for API traffic
    balance leastconn

    # Stick table for rate limiting (per source IP)
    stick-table type ip size 100k expire 30s store conn_rate(10s)
    # Track connection rate
    tcp-request connection track-sc0 src
    # Deny if more than 100 connections in 10 seconds
    tcp-request connection reject if { sc_conn_rate(0) gt 100 }

    # Health check: TCP check with HTTP validation
    option httpchk GET /api/health HTTP/1.1\r\nHost:\ api.example.com
    http-check expect string "healthy"

    # Compression for API responses
    compression algo gzip
    compression type application/json text/plain text/html

    # Server definitions with inter-check intervals
    server api1 10.0.2.10:8080 check inter 2000 rise 2 fall 3
    server api2 10.0.2.11:8080 check inter 2000 rise 2 fall 3
    server api3 10.0.2.12:8080 check inter 2000 rise 2 fall 3
    server api4 10.0.2.13:8080 check inter 2000 rise 2 fall 3

#---------------------------------------------------------------------
# Backend: Admin servers (source IP hash for session persistence)
#---------------------------------------------------------------------
backend admin_backend
    # Source IP hash - same client always goes to same server
    balance source

    # TCP health check on port 8080
    option tcp-check
    tcp-check connect port 8080

    # Longer timeout for admin operations
    timeout server 120s

    # Server definitions
    server admin1 10.0.3.10:8080 check
    server admin2 10.0.3.11:8080 check

#---------------------------------------------------------------------
# Backend: Internal services (URI hash for cache efficiency)
#---------------------------------------------------------------------
backend internal_backend
    # URI hash - same URI always goes to same server (cache locality)
    balance uri

    # Health check: HTTP with custom header
    option httpchk GET /internal/health HTTP/1.1\r\nHost:\ internal.example.com\r\nX-Health-Check:\ true
    http-check expect status 200-299

    # Server definitions with weight adjustment
    server internal1 10.0.4.10:8080 check weight 50
    server internal2 10.0.4.11:8080 check weight 100
    server internal3 10.0.4.12:8080 check weight 150

#---------------------------------------------------------------------
# Additional backend examples
#---------------------------------------------------------------------

# Backend with custom health check intervals
backend custom_health_backend
    balance roundrobin

    # Custom health check parameters:
    # inter: interval between checks (default: 2000ms)
    # rise: number of successful checks before marking server up (default: 2)
    # fall: number of failed checks before marking server down (default: 3)
    # downinter: interval when server is down (faster detection)
    server srv1 10.0.5.10:8080 check inter 5000 rise 2 fall 3 downinter 1000
    server srv2 10.0.5.11:8080 check inter 5000 rise 2 fall 3 downinter 1000

# Backend with connection limits and queuing
backend limited_backend
    balance roundrobin

    # Global backend connection limit
    fullconn 1000

    # Server with maxconn and maxqueue limits
    server lim1 10.0.6.10:8080 check maxconn 250 maxqueue 50
    server lim2 10.0.6.11:8080 check maxconn 250 maxqueue 50
