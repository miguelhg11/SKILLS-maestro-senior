# Nginx mTLS (Mutual TLS) Configuration

server {
    listen 443 ssl;
    server_name api.example.com;

    # Server certificate
    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/private/server.key;

    # CA certificate to verify client certificates
    ssl_client_certificate /etc/ssl/certs/ca.crt;

    # Require client certificate
    ssl_verify_client on;

    # Certificate verification depth
    ssl_verify_depth 2;

    # TLS protocols and ciphers
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        proxy_pass http://backend;

        # Pass client certificate information to backend
        proxy_set_header X-SSL-Client-Cert $ssl_client_cert;
        proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
        proxy_set_header X-SSL-Client-I-DN $ssl_client_i_dn;
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header X-SSL-Client-Serial $ssl_client_serial;
    }
}

# Optional client certificate example
server {
    listen 443 ssl;
    server_name api-optional.example.com;

    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/private/server.key;
    ssl_client_certificate /etc/ssl/certs/ca.crt;

    # Make client certificate optional
    ssl_verify_client optional;
    ssl_verify_depth 2;

    location / {
        # Allow if client cert valid OR has API key
        set $auth_pass 0;

        if ($ssl_client_verify = "SUCCESS") {
            set $auth_pass 1;
        }

        if ($http_x_api_key != "") {
            set $auth_pass 1;
        }

        if ($auth_pass = 0) {
            return 401 "Authentication required";
        }

        proxy_pass http://backend;
        proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
        proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
    }
}
